<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ğŸš€ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
<!-- Ø¥Ø¶Ø§ÙØ© Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<!-- Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<!-- Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ· Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f172a;
    --card: #1e293b;
    --card-hover: #334155;
    --primary: #3b82f6;
    --primary-dark: #2563eb;
    --accent: #8b5cf6;
    --success: #10b981;
    --success-dark: #059669;
    --muted: #94a3b8;
    --danger: #ef4444;
    --danger-dark: #dc2626;
    --warning: #f59e0b;
    --warning-dark: #d97706;
    --info: #06b6d4;
    --radius: 16px;
    --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: 'Tajawal', system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, "Noto Kufi Arabic", "Noto Sans Arabic", sans-serif;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
    color: #fff;
    overflow-x: hidden;
  }

  body {
    padding: 0;
    background-attachment: fixed;
  }

  h1, h2, h3, h4 {
    margin: 0;
    font-weight: 700;
    line-height: 1.2;
  }

  input, select, button, textarea {
    border-radius: var(--radius);
    border: none;
    padding: 12px 16px;
    font-size: 14px;
    font-family: inherit;
    transition: var(--transition);
  }

  input, select, textarea {
    width: 100%;
    margin-bottom: 12px;
    background: #2d3748;
    color: #fff;
    border: 2px solid #4a5568;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    background: #374151;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  button {
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: relative;
    overflow: hidden;
  }

  button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }

  button:hover::before {
    left: 100%;
  }

  button.primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: #fff;
  }

  button.success {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    color: #fff;
  }

  button.danger {
    background: linear-gradient(135deg, var(--danger), var(--danger-dark));
    color: #fff;
  }

  button.warning {
    background: linear-gradient(135deg, var(--warning), var(--warning-dark));
    color: #fff;
  }

  button.ghost {
    background: transparent;
    color: #fff;
    border: 2px solid #4a5568;
  }

  button.ghost:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--primary);
  }

  button.small {
    padding: 8px 12px;
    font-size: 12px;
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  button:active {
    transform: translateY(0);
  }

  .hidden {
    display: none !important;
  }

  .card {
    background: var(--card);
    padding: 24px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: var(--transition);
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .list-item {
    padding: 16px;
    border-radius: var(--radius);
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: var(--transition);
    border-left: 4px solid transparent;
  }

  .list-item:hover {
    transform: translateX(-5px);
    background: var(--card-hover);
  }

  .debt-item {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
    border-left-color: var(--primary);
  }

  .qat-item {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    border-left-color: var(--success);
  }

  /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø³Ù† */
  .nav-container {
    background: linear-gradient(135deg, var(--card) 0%, #1e293b 100%);
    padding: 15px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: var(--shadow);
    position: sticky;
    top: 0;
    z-index: 1000;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .nav-container.compact {
    padding: 8px 20px;
  }

  .nav-container.compact .nav-header h1 {
    font-size: 18px;
  }

  .nav-container.compact .nav-header p {
    display: none;
  }

  .nav-container.compact .nav-buttons {
    margin-top: 8px;
  }

  .nav-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 15px;
  }

  .nav-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 200px;
  }

  .nav-title i {
    font-size: 28px;
    color: var(--primary);
  }

  .nav-title-text h1 {
    font-size: 20px;
    margin: 0;
    transition: font-size 0.3s ease;
  }

  .nav-title-text p {
    color: var(--muted);
    margin: 0;
    font-size: 12px;
    transition: all 0.3s ease;
  }

  .nav-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #currentDateTime {
    color: var(--muted);
    font-size: 12px;
    text-align: left;
    min-width: 150px;
  }

  .nav-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
    transition: margin-top 0.3s ease;
  }

  .nav-buttons button {
    flex: 1;
    min-width: 110px;
    padding: 8px 12px;
    font-size: 12px;
  }

  .nav-buttons button i {
    font-size: 14px;
  }

  /* Pages */
  .page {
    display: none;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    animation: fadeInUp 0.5s ease-out;
    padding-top: 80px;
    transition: padding-top 0.3s ease;
  }

  .page.compact-view {
    padding-top: 60px;
  }

  .page.active {
    display: block;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Login Page */
  #loginPage {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  #loginCard {
    background: var(--card);
    color: #fff;
    padding: 40px;
    border-radius: 24px;
    width: 100%;
    max-width: 440px;
    text-align: center;
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255, 255, 255, 0.1);
    animation: scaleIn 0.5s ease-out;
  }

  @keyframes scaleIn {
    from {
      opacity: 0;
      transform: scale(0.9);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  #loginCard input {
    background: #2d3748;
    border: 2px solid #4a5568;
    color: #fff;
    padding: 14px;
    width: 100%;
    margin-bottom: 16px;
  }

  #loginCard button {
    width: 100%;
    margin-top: 12px;
  }

  .login-options {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .login-options button {
    flex: 1;
  }

  /* Search */
  .search-container {
    margin-bottom: 20px;
    position: relative;
  }

  .search-container input {
    background: #2d3748;
    border: 2px solid #4a5568;
    color: #fff;
    padding: 14px 50px 14px 14px;
    margin-bottom: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.3-4.3'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: calc(100% - 16px) center;
  }

  .search-container .search-btn {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    padding: 8px 12px;
  }

  /* Debt Status Colors */
  .debt-high {
    color: var(--danger);
    font-weight: bold;
  }

  .debt-medium {
    color: var(--warning);
    font-weight: bold;
  }

  .debt-low {
    color: var(--success);
    font-weight: bold;
  }

  .debt-paid {
    color: var(--muted);
    text-decoration: line-through;
  }

  /* Payment Section */
  .payment-section {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    padding: 16px;
    border-radius: 12px;
    margin-top: 12px;
    border-left: 4px solid var(--success);
  }

  /* Summary Cards */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .summary-card {
    padding: 20px;
    border-radius: var(--radius);
    text-align: center;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    transition: var(--transition);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .summary-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .summary-card h3 {
    font-size: 14px;
    margin-bottom: 8px;
    color: var(--muted);
  }

  .summary-card p {
    font-size: 24px;
    font-weight: 800;
    margin: 0;
  }

  .summary-card.total {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
    border-left: 4px solid var(--primary);
  }

  .summary-card.paid {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    border-left: 4px solid var(--success);
  }

  .summary-card.remaining {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
    border-left: 4px solid var(--danger);
  }

  /* Debt History */
  .debt-history {
    margin-top: 24px;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
    background: var(--card);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  .history-table th, .history-table td {
    padding: 16px;
    text-align: right;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .history-table th {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    font-weight: 600;
    font-size: 14px;
  }

  .history-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .history-date {
    color: var(--muted);
    font-size: 12px;
  }

  /* Date Selection */
  .date-selection {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  .date-selection button {
    flex: 0 0 auto;
  }

  .date-selection input {
    flex: 1;
    margin-bottom: 0;
    min-width: 160px;
  }

  .day-selector {
    position: relative;
    display: inline-block;
  }

  .days-dropdown {
    display: none;
    position: absolute;
    background: var(--card);
    min-width: 140px;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    border-radius: 12px;
    padding: 8px;
    top: 100%;
    left: 0;
    margin-top: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .days-dropdown button {
    display: block;
    width: 100%;
    text-align: right;
    background: none;
    border: none;
    color: #fff;
    padding: 12px;
    cursor: pointer;
    border-radius: 8px;
    margin-bottom: 4px;
  }

  .days-dropdown button:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .day-selector.active .days-dropdown {
    display: block;
    animation: fadeInUp 0.2s ease-out;
  }

  /* Sync Status */
  .sync-status {
    position: fixed;
    bottom: 20px;
    left: 20px;
    background: var(--card);
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow);
    border: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 1000;
    transition: var(--transition);
  }

  .sync-status.online {
    color: var(--success);
    border-left: 4px solid var(--success);
  }

  .sync-status.offline {
    color: var(--danger);
    border-left: 4px solid var(--danger);
  }

  .sync-status.syncing {
    color: var(--warning);
    border-left: 4px solid var(--warning);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* Export Buttons */
  .export-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .export-buttons button {
    flex: 1;
    min-width: 140px;
  }

  /* Management Buttons */
  .management-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  .management-buttons button {
    flex: 1;
    min-width: 140px;
  }

  /* Progress Bar */
  .progress-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    overflow: hidden;
    margin: 8px 0;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--success), var(--primary));
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  /* Loading States */
  .loading {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid transparent;
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Toast Notifications */
  .toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    z-index: 10000;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideDown 0.3s ease-out;
    border-left: 4px solid rgba(255, 255, 255, 0.3);
  }

  .toast.error {
    background: var(--danger);
  }

  .toast.warning {
    background: var(--warning);
  }

  .toast.info {
    background: var(--info);
  }

  @keyframes slideDown {
    from { top: -100px; opacity: 0; }
    to { top: 20px; opacity: 1; }
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .stat-item {
    background: var(--card);
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 12px;
    color: var(--muted);
  }

  /* Quick Actions */
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin: 20px 0;
  }

  .quick-action-btn {
    background: var(--card);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
  }

  .quick-action-btn:hover {
    background: var(--card-hover);
    transform: translateY(-2px);
    border-color: var(--primary);
  }

  .quick-action-btn i {
    font-size: 24px;
    margin-bottom: 8px;
    color: var(--primary);
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
  }

  .modal-content {
    background: var(--card);
    padding: 32px;
    border-radius: 24px;
    width: 100%;
    max-width: 500px;
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .page {
      padding: 16px;
      padding-top: 100px;
    }
    
    .page.compact-view {
      padding-top: 80px;
    }
    
    .nav-header {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
    }
    
    .nav-title {
      min-width: auto;
    }
    
    .nav-controls {
      justify-content: space-between;
    }
    
    .nav-buttons {
      flex-direction: row;
      overflow-x: auto;
      padding-bottom: 5px;
    }
    
    .nav-buttons button {
        min-width: 100px;
        flex: none;
    }
    
    #currentDateTime {
        min-width: auto;
        font-size: 11px;
    }
    
    .summary-cards {
      grid-template-columns: 1fr;
    }
    
    .export-buttons, .management-buttons {
      flex-direction: column;
    }
    
    .date-selection {
      flex-direction: column;
      align-items: stretch;
    }
    
    .date-selection input {
      min-width: auto;
    }
    
    .history-table {
      font-size: 12px;
    }
    
    .history-table th, .history-table td {
      padding: 12px 8px;
    }
  }

  @media (max-width: 480px) {
    .card {
      padding: 16px;
    }
    
    #loginCard {
      padding: 24px;
      margin: 16px;
    }
    
    .summary-card {
      padding: 16px;
      min-height: 80px;
    }
    
    .summary-card p {
      font-size: 20px;
    }
    
    .nav-container {
      padding: 10px 15px;
    }
    
    .nav-container.compact {
      padding: 5px 15px;
    }
    
    .nav-title-text h1 {
      font-size: 16px;
    }
    
    .nav-buttons button {
      min-width: 80px;
      font-size: 11px;
      padding: 6px 8px;
    }
    
    .page {
      padding-top: 90px;
    }
    
    .page.compact-view {
      padding-top: 70px;
    }
  }

  /* Enhanced Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--card);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
  }
</style>
</head>
<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage">
  <div id="loginCard">
    <div style="margin-bottom: 24px;">
      <i class="fas fa-chart-line" style="font-size: 48px; color: var(--primary); margin-bottom: 16px;"></i>
      <h2>ğŸš€ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h2>
      <p style="color: var(--muted); margin-top: 8px;">Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ© ÙˆØ³Ø±ÙŠØ¹Ø© Ù„Ø¯ÙŠÙˆÙ†Ùƒ ÙˆØ£Ø¹Ù…Ø§Ù„Ùƒ</p>
    </div>
    
    <input id="loginName" type="text" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <input id="loginPassword" type="password" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    
    <div class="login-options">
      <button id="btnLogin" class="primary">
        <i class="fas fa-sign-in-alt"></i>
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      </button>
      <button id="btnRegister" class="success">
        <i class="fas fa-user-plus"></i>
        Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
      </button>
    </div>
    
    <p id="loginMessage" style="color: var(--muted); font-size: 14px; margin-top: 16px;"></p>
    
    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
      <p style="color: var(--muted); font-size: 12px;">
        <i class="fas fa-shield-alt"></i>
        Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù…ÙŠØ© ÙˆÙ…Ø¤Ù…Ù†Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      </p>
    </div>
  </div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="appPage" class="hidden">
  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø³Ù† -->
  <div class="nav-container" id="navContainer">
    <div class="nav-header">
      <div class="nav-title">
        <i class="fas fa-chart-line"></i>
        <div class="nav-title-text">
          <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª</h1>
          <p id="welcomeText">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</p>
        </div>
      </div>
      
      <div class="nav-controls">
        <div id="currentDateTime"></div>
        <button id="logoutBtn" class="danger small">
          <i class="fas fa-sign-out-alt"></i>
          Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>

    <div class="nav-buttons">
      <button id="navDashboard" class="warning">
        <i class="fas fa-tachometer-alt"></i>
        Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </button>
      <button id="navDebts" class="primary">
        <i class="fas fa-hand-holding-usd"></i>
        Ø§Ù„Ø¯ÙŠÙˆÙ†
      </button>
      <button id="navQat" class="success">
        <i class="fas fa-leaf"></i>
        Ø§Ù„Ù‚Ø§Øª
      </button>
      <button id="navSummary" class="info">
        <i class="fas fa-chart-pie"></i>
        Ø§Ù„Ù…Ù„Ø®Øµ
      </button>
      <button id="navSettings" class="ghost">
        <i class="fas fa-cog"></i>
        Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      </button>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
  <div id="dashboardPage" class="page">
    <div class="card">
      <h2><i class="fas fa-tachometer-alt"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
      <p style="color: var(--muted); margin-bottom: 24px;">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø£Ø¹Ù…Ø§Ù„Ùƒ</p>
      
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="dashboardTotalDebts">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dashboardTotalPaid">0</div>
          <div class="stat-label">Ø§Ù„Ù…Ø³Ø¯Ø¯</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dashboardTotalRemaining">0</div>
          <div class="stat-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="dashboardTotalQat">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø§Øª</div>
        </div>
      </div>
    </div>

    <div class="quick-actions">
      <div class="quick-action-btn" id="quickAddDebt">
        <i class="fas fa-plus-circle"></i>
        <div>Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†</div>
      </div>
      <div class="quick-action-btn" id="quickAddPayment">
        <i class="fas fa-money-bill-wave"></i>
        <div>ØªØ³Ø¯ÙŠØ¯ Ø¯ÙØ¹Ø©</div>
      </div>
      <div class="quick-action-btn" id="quickAddQat">
        <i class="fas fa-leaf"></i>
        <div>ØªØ³Ø¬ÙŠÙ„ Ù‚Ø§Øª</div>
      </div>
      <div class="quick-action-btn" id="quickExport">
        <i class="fas fa-file-export"></i>
        <div>ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ±</div>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-chart-line"></i> Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
      <div id="recentDebts"></div>
    </div>

    <div class="card">
      <h3><i class="fas fa-history"></i> Ø¢Ø®Ø± Ø§Ù„ØªØ³Ø¯ÙŠØ¯Ø§Øª</h3>
      <div id="recentPayments"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† -->
  <div id="debtsPage" class="page">
    <div class="search-container">
      <input type="text" id="searchDebts" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®... Ø«Ù… Ø§Ø¶ØºØ· Enter Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" />
      <button id="quickSearchBtn" class="small primary search-btn">
        <i class="fas fa-search"></i>
      </button>
    </div>

    <div class="summary-cards">
      <div class="summary-card total">
        <h3><i class="fas fa-hand-holding-usd"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
        <p id="totalDebts">0 Ø±ÙŠØ§Ù„</p>
      </div>
      <div class="summary-card paid">
        <h3><i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø³Ø¯Ø¯</h3>
        <p id="totalPaid">0 Ø±ÙŠØ§Ù„</p>
      </div>
      <div class="summary-card remaining">
        <h3><i class="fas fa-clock"></i> Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3>
        <p id="totalRemaining">0 Ø±ÙŠØ§Ù„</p>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-plus-circle"></i> ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†</h3>
      <input id="debtName" type="text" placeholder="ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†" />
      <input id="debtAmount" type="number" placeholder="ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ" />
      
      <div class="date-selection">
        <input id="debtDate" type="date" />
        <div class="day-selector" id="daySelectorDebt">
          <button type="button" id="showDaysDebt" class="small ghost">
            <i class="fas fa-calendar-alt"></i>
            Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…
          </button>
          <div class="days-dropdown" id="daysDropdownDebt"></div>
        </div>
        <button id="setTodayDebt" class="small ghost">
          <i class="fas fa-calendar-day"></i>
          Ø§Ù„ÙŠÙˆÙ…
        </button>
        <button id="setYesterdayDebt" class="small ghost">
          <i class="fas fa-calendar-minus"></i>
          Ø£Ù…Ø³
        </button>
      </div>
      
      <select id="debtTime">
        <option value="ØµØ¨Ø§Ø­Ø§Ù‹">ğŸŒ… ØµØ¨Ø§Ø­Ø§Ù‹</option>
        <option value="Ù…Ø³Ø§Ø¡Ù‹">ğŸŒ™ Ù…Ø³Ø§Ø¡Ù‹</option>
      </select>
      
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button id="saveDebt" class="primary" style="flex: 2;">
          <i class="fas fa-save"></i>
          Ø­ÙØ¸ Ø§Ù„Ø¯ÙŠÙ†
        </button>
        <button id="clearDebt" class="ghost" style="flex: 1;">
          <i class="fas fa-broom"></i>
          ØªÙØ±ÙŠØº
        </button>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-money-bill-wave"></i> ØªØ³Ø¯ÙŠØ¯ Ø¯ÙØ¹Ø©</h3>
      <select id="debtorSelect">
        <option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ¯ÙŠÙ†</option>
      </select>
      <input id="paymentAmount" type="number" placeholder="ğŸ’° Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯" />
      
      <div class="date-selection">
        <input id="paymentDate" type="date" />
        <div class="day-selector" id="daySelectorPayment">
          <button type="button" id="showDaysPayment" class="small ghost">
            <i class="fas fa-calendar-alt"></i>
            Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…
          </button>
          <div class="days-dropdown" id="daysDropdownPayment"></div>
        </div>
        <button id="setTodayPayment" class="small ghost">
          <i class="fas fa-calendar-day"></i>
          Ø§Ù„ÙŠÙˆÙ…
        </button>
        <button id="setYesterdayPayment" class="small ghost">
          <i class="fas fa-calendar-minus"></i>
          Ø£Ù…Ø³
        </button>
      </div>
      
      <button id="savePayment" class="success">
        <i class="fas fa-check-circle"></i>
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ³Ø¯ÙŠØ¯
      </button>
    </div>

    <div class="card">
      <h3><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
      <div id="debtsList"></div>
    </div>

    <!-- Ù‚Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ -->
    <div class="card debt-history hidden" id="debtHistoryCard">
      <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
      <div class="export-buttons">
        <button id="exportExcel" class="primary">
          <i class="fas fa-file-excel"></i>
          ØªØµØ¯ÙŠØ± Excel
        </button>
        <button id="exportWord" class="success">
          <i class="fas fa-file-word"></i>
          ØªØµØ¯ÙŠØ± Word
        </button>
      </div>
      <div id="debtHistoryList"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù‚Ø§Øª -->
  <div id="qatPage" class="page">
    <div class="search-container">
      <input type="text" id="searchQat" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù‚Ø§Øª..." />
    </div>

    <div class="card">
      <h3><i class="fas fa-leaf"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
      <input id="qatType" type="text" placeholder="ğŸŒ¿ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Øª" />
      <input id="qatCountInput" type="number" placeholder="ğŸ”¢ Ø§Ù„Ø¹Ø¯Ø¯" />
      
      <div class="date-selection">
        <input id="qatDate" type="date" />
        <div class="day-selector" id="daySelectorQat">
          <button type="button" id="showDaysQat" class="small ghost">
            <i class="fas fa-calendar-alt"></i>
            Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…
          </button>
          <div class="days-dropdown" id="daysDropdownQat"></div>
        </div>
        <button id="setTodayQat" class="small ghost">
          <i class="fas fa-calendar-day"></i>
          Ø§Ù„ÙŠÙˆÙ…
        </button>
        <button id="setYesterdayQat" class="small ghost">
          <i class="fas fa-calendar-minus"></i>
          Ø£Ù…Ø³
        </button>
      </div>
      
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button id="saveQat" class="primary" style="flex: 2;">
          <i class="fas fa-save"></i>
          Ø­ÙØ¸
        </button>
        <button id="clearQat" class="ghost" style="flex: 1;">
          <i class="fas fa-broom"></i>
          ØªÙØ±ÙŠØº
        </button>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø§Øª</h3>
      <div id="qatList"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ø®Øµ -->
  <div id="summaryPage" class="page">
    <div class="card">
      <h3><i class="fas fa-chart-pie"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h3>
      <div class="export-buttons">
        <button id="exportSummaryExcel" class="primary">
          <i class="fas fa-file-excel"></i>
          ØªØµØ¯ÙŠØ± Excel
        </button>
        <button id="exportSummaryWord" class="success">
          <i class="fas fa-file-word"></i>
          ØªØµØ¯ÙŠØ± Word
        </button>
      </div>
      <div id="debtsSummary"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div id="settingsPage" class="page">
    <div class="card">
      <h3><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
      
      <div class="management-buttons">
        <button id="changePassword" class="warning">
          <i class="fas fa-key"></i>
          ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        </button>
        <button id="deleteData" class="danger">
          <i class="fas fa-trash"></i>
          Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button id="exportAllData" class="primary">
          <i class="fas fa-download"></i>
          Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        </button>
        <button id="importData" class="success">
          <i class="fas fa-upload"></i>
          Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
      </div>
    </div>

    <div class="card">
      <h3><i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="statsTotalDebts">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statsTotalRecords">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statsActiveDebts">0</div>
          <div class="stat-label">Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù†Ø´Ø·Ø©</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statsQatRecords">0</div>
          <div class="stat-label">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø§Øª</div>
        </div>
      </div>
      <div id="backupStatus" style="font-size: 10px; color: var(--muted); margin-top: 5px; text-align: center;"></div>
    </div>
  </div>
</div>

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
<div id="syncStatus" class="sync-status hidden">
  <span id="syncIcon">â†»</span>
  <span id="syncText">Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</span>
</div>

<!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div id="changePasswordModal" class="modal hidden">
  <div class="modal-content">
    <h3 style="margin-bottom:24px;display:flex;align-items:center;gap:12px;">
      <i class="fas fa-key"></i>
      ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    </h3>
    
    <input type="password" id="currentPassword" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©" />
    <input type="password" id="newPassword" placeholder="ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" />
    <input type="password" id="confirmPassword" placeholder="âœ… ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    
    <div style="display:flex;gap:12px;margin-top:24px;">
      <button id="saveNewPassword" class="primary" style="flex:2;">Ø­ÙØ¸</button>
      <button id="cancelChangePassword" class="ghost" style="flex:1;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  
  // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  const firebaseConfig = {
    apiKey: "AIzaSyB1KgAYSe--Vq0ninrIaMDSh34llRJfW9Y",
    authDomain: "qat-debt-management-system.firebaseapp.com",
    databaseURL: "https://qat-debt-management-system-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "qat-debt-management-system",
    storageBucket: "qat-debt-management-system.firebasestorage.app",
    messagingSenderId: "827162170021",
    appId: "1:827162170021:web:ba352c809d7a4fc5b1f34c"
  };
  
  // ØªÙ‡ÙŠØ¦Ø© Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  
  // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
  const KEY_USER = 'dq_current_user';
  const KEY_PASSWORD = 'dq_user_password';
  const KEY_DEBTS = 'dq_debts';
  const KEY_QAT = 'dq_qat';

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
  let currentUser = null;
  let userPassword = null;
  let debts = [];
  let qats = [];
  let isOnline = false;
  let syncInProgress = false;
  let backupData = null;

  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : ''}`;
    toast.innerHTML = `
      <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'info' ? 'info-circle' : 'check-circle'}"></i>
      ${message}
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function hashPassword(password) {
    return btoa(password + 'salt123');
  }

  function verifyPassword(password, hashedPassword) {
    return hashPassword(password) === hashedPassword;
  }

  function uid(prefix='id'){ 
    return prefix+'_'+Date.now()+'_'+Math.floor(Math.random()*9999); 
  }

  function showApp(){ 
    loginPage.classList.add('hidden'); 
    appPage.classList.remove('hidden');
    showPage('dashboardPage');
    updateDateTime();
    checkConnection();
    setupNavScroll();
  }
  
  function showLogin(){ 
    loginPage.classList.remove('hidden'); 
    appPage.classList.add('hidden'); 
    syncStatus.classList.add('hidden');
    loginName.value = '';
    loginPassword.value = '';
    loginMessage.textContent = '';
  }

  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
    document.querySelectorAll('.day-selector').forEach(selector => {
      selector.classList.remove('active');
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
    if (pageId === 'dashboardPage') {
      updateDashboard();
    } else if (pageId === 'debtsPage') {
      renderDebts();
      updateSummary();
      updateDebtorSelect();
    } else if (pageId === 'qatPage') {
      renderQats();
    } else if (pageId === 'summaryPage') {
      updateSummary();
      renderDebtsSummary();
    } else if (pageId === 'settingsPage') {
      updateSettingsStats();
    }
  }

  function updateDateTime() {
    const now = new Date();
    const options = { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    const dateTimeString = now.toLocaleDateString('ar-SA', options);
    const dateTimeElement = document.getElementById('currentDateTime');
    if (dateTimeElement) {
      dateTimeElement.textContent = dateTimeString;
    }
  }

  // Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù†
  function setupUserSystem() {
    window.createAccount = function(name, password) {
        if(!name || !password){ 
            return { success: false, message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' };
        }
        
        if (password.length < 4) {
            return { success: false, message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„' };
        }
        
        const existingUser = localStorage.getItem(KEY_USER);
        if (existingUser === name) {
            return { success: false, message: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹' };
        }
        
        try {
            currentUser = name;
            userPassword = hashPassword(password);
            debts = [];
            qats = [];
            
            localStorage.setItem(KEY_USER, currentUser);
            localStorage.setItem(`${KEY_PASSWORD}_${currentUser}`, userPassword);
            localStorage.setItem(`${KEY_DEBTS}_${currentUser}`, JSON.stringify(debts));
            localStorage.setItem(`${KEY_QAT}_${currentUser}`, JSON.stringify(qats));
            
            return { 
                success: true, 
                message: `ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${name}`,
                user: currentUser
            };
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
            return { success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨' };
        }
    };

    window.loginUser = function(name, password) {
        if(!name || !password){ 
            return { success: false, message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±' };
        }
        
        try {
            const storedUser = localStorage.getItem(KEY_USER);
            if (storedUser !== name) {
                return { success: false, message: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' };
            }
            
            const storedPassword = localStorage.getItem(`${KEY_PASSWORD}_${name}`);
            if (!storedPassword || !verifyPassword(password, storedPassword)) {
                return { success: false, message: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©' };
            }
            
            currentUser = name;
            userPassword = storedPassword;
            
            const storedDebts = localStorage.getItem(`${KEY_DEBTS}_${name}`);
            const storedQat = localStorage.getItem(`${KEY_QAT}_${name}`);
            
            debts = storedDebts ? JSON.parse(storedDebts) : [];
            qats = storedQat ? JSON.parse(storedQat) : [];
            
            return { 
                success: true, 
                message: `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}!`,
                user: currentUser
            };
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
            return { success: false, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' };
        }
    };
  }

  // Ø¥Ø¯Ø§Ø±Ø© Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…ØªØ­Ø±Ùƒ
  function setupNavScroll() {
    const navContainer = document.getElementById('navContainer');
    const pages = document.querySelectorAll('.page');
    let lastScrollY = window.scrollY;
    let isCompact = false;

    window.addEventListener('scroll', () => {
        const currentScrollY = window.scrollY;
        
        if (currentScrollY > 50 && !isCompact) {
            navContainer.classList.add('compact');
            pages.forEach(page => page.classList.add('compact-view'));
            isCompact = true;
        } else if (currentScrollY <= 50 && isCompact) {
            navContainer.classList.remove('compact');
            pages.forEach(page => page.classList.remove('compact-view'));
            isCompact = false;
        }
        
        lastScrollY = currentScrollY;
    });
  }

  // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  function setupDashboardActions() {
    const addDebtBtn = document.getElementById('quickAddDebt');
    const addPaymentBtn = document.getElementById('quickAddPayment');
    const addQatBtn = document.getElementById('quickAddQat');
    const exportReportBtn = document.getElementById('quickExport');
    
    if (addDebtBtn) {
        addDebtBtn.addEventListener('click', function() {
            showPage('debtsPage');
            setTimeout(() => {
                document.getElementById('debtName').focus();
                showToast('ğŸ‘¤ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ† Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯', 'info');
            }, 300);
        });
    }

    if (addPaymentBtn) {
        addPaymentBtn.addEventListener('click', function() {
            showPage('debtsPage');
            setTimeout(() => {
                const debtorSelect = document.getElementById('debtorSelect');
                if (debtorSelect && debtorSelect.options.length > 1) {
                    debtorSelect.focus();
                    showToast('ğŸ’° Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ¯ÙŠÙ† ÙˆØ£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯', 'info');
                } else {
                    showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù†Ø´Ø·Ø© Ù„Ù„ØªØ³Ø¯ÙŠØ¯', 'warning');
                }
            }, 300);
        });
    }

    if (addQatBtn) {
        addQatBtn.addEventListener('click', function() {
            showPage('qatPage');
            setTimeout(() => {
                document.getElementById('qatType').focus();
                showToast('ğŸŒ¿ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ù‚Ø§Øª', 'info');
            }, 300);
        });
    }

    if (exportReportBtn) {
        exportReportBtn.addEventListener('click', function() {
            showExportOptions();
        });
    }
  }

  function showExportOptions() {
    const exportHTML = `
        <div class="modal" id="exportModal">
            <div class="modal-content">
                <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <i class="fas fa-file-export"></i>
                    Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
                </h3>
                <p style="color:var(--muted);margin-bottom:20px;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØµØ¯ÙŠØ±Ù‡:</p>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:25px;">
                    <button class="primary" onclick="exportDebtsToExcel()">
                        <i class="fas fa-file-excel"></i>
                        Ø¯ÙŠÙˆÙ† - Excel
                    </button>
                    <button class="success" onclick="exportDebtsToWord()">
                        <i class="fas fa-file-word"></i>
                        Ø¯ÙŠÙˆÙ† - Word
                    </button>
                    <button class="primary" onclick="exportSummaryToExcel()">
                        <i class="fas fa-file-excel"></i>
                        Ù…Ù„Ø®Øµ - Excel
                    </button>
                    <button class="success" onclick="exportSummaryToWord()">
                        <i class="fas fa-file-word"></i>
                        Ù…Ù„Ø®Øµ - Word
                    </button>
                </div>
                
                <div style="display:flex;gap:10px;">
                    <button class="ghost" style="flex:1;" onclick="closeExportModal()">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', exportHTML);
  }

  // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
  function backupAllData() {
    try {
        backupData = {
            debts: JSON.parse(JSON.stringify(debts)),
            qats: JSON.parse(JSON.stringify(qats)),
            user: currentUser,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        localStorage.setItem(`backup_${currentUser}`, JSON.stringify(backupData));
        
        showToast('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        
        const debtCount = debts.length;
        const qatCount = qats.length;
        const totalAmount = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
        
        showToast(`ğŸ“Š ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©: ${debtCount} Ø¯ÙŠÙˆÙ†ØŒ ${qatCount} Ø³Ø¬Ù„Ø§Øª Ù‚Ø§ØªØŒ ${totalAmount} Ø±ÙŠØ§Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ`, 'info');
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ:', error);
        showToast('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©', 'error');
    }
  }

  function restoreData() {
    if (!backupData) {
        const storedBackup = localStorage.getItem(`backup_${currentUser}`);
        if (storedBackup) {
            backupData = JSON.parse(storedBackup);
        }
    }
    
    if (!backupData) {
        showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©', 'error');
        return;
    }
    
    if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ\n\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø©: ${new Date(backupData.timestamp).toLocaleString('ar-SA')}\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${backupData.user}\nğŸ“ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: ${backupData.debts.length} Ø¯ÙŠÙˆÙ†ØŒ ${backupData.qats.length} Ø³Ø¬Ù„Ø§Øª Ù‚Ø§Øª`)) {
        try {
            debts = JSON.parse(JSON.stringify(backupData.debts));
            qats = JSON.parse(JSON.stringify(backupData.qats));
            
            saveToLocalStorage();
            refreshUI();
            
            showToast('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            showToast('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        }
    }
  }

  function deleteAllData() {
    if (confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ ${debts.length} Ø³Ø¬Ù„ Ø¯ÙŠÙˆÙ†\nâ€¢ ${qats.length} Ø³Ø¬Ù„ Ù‚Ø§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±`)) {
        
        backupAllData();
        
        debts = [];
        qats = [];
        
        saveToLocalStorage();
        refreshUI();
        
        showToast('âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        showToast('ğŸ’¾ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù†Ù‡Ø§', 'info');
    }
  }

  function exportDataToFile() {
    try {
        const exportData = {
            debts: debts,
            qats: qats,
            user: currentUser,
            timestamp: new Date().toISOString(),
            version: '1.0'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Ù†Ø³Ø®Ø©-Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©-${currentUser}-${new Date().toISOString().slice(0,10)}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        
        showToast('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ù„Ù‰ Ù…Ù„Ù', 'success');
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        showToast('âŒ ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
  }

  function importDataFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.txt';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                if (isValidBackupData(importedData)) {
                    if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„ÙØŸ\n\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø©: ${new Date(importedData.timestamp).toLocaleString('ar-SA')}\nğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${importedData.user}\nğŸ“ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰: ${importedData.debts.length} Ø¯ÙŠÙˆÙ†ØŒ ${importedData.qats.length} Ø³Ø¬Ù„Ø§Øª Ù‚Ø§Øª`)) {
                        
                        backupData = importedData;
                        debts = JSON.parse(JSON.stringify(importedData.debts));
                        qats = JSON.parse(JSON.stringify(importedData.qats));
                        
                        saveToLocalStorage();
                        refreshUI();
                        
                        showToast('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    }
                } else {
                    showToast('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù', 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showToast('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        };
        
        reader.readAsText(file);
    };
    
    input.click();
  }

  function isValidBackupData(data) {
    return data && 
           data.debts && Array.isArray(data.debts) &&
           data.qats && Array.isArray(data.qats) &&
           data.user && 
           data.timestamp;
  }

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  function saveToLocalStorage() {
    if (!currentUser) return;
    
    localStorage.setItem(KEY_USER, currentUser);
    localStorage.setItem(`${KEY_PASSWORD}_${currentUser}`, userPassword);
    localStorage.setItem(`${KEY_DEBTS}_${currentUser}`, JSON.stringify(debts));
    localStorage.setItem(`${KEY_QAT}_${currentUser}`, JSON.stringify(qats));
    localStorage.setItem(`lastUpdate_${currentUser}`, new Date().toISOString());
  }

  function loadFromLocalStorage() {
    if (!currentUser) return;
    
    const storedPassword = localStorage.getItem(`${KEY_PASSWORD}_${currentUser}`);
    const storedDebts = localStorage.getItem(`${KEY_DEBTS}_${currentUser}`);
    const storedQat = localStorage.getItem(`${KEY_QAT}_${currentUser}`);
    
    userPassword = storedPassword || hashPassword('123456');
    debts = storedDebts ? JSON.parse(storedDebts) : [];
    qats = storedQat ? JSON.parse(storedQat) : [];
    
    debts.forEach(debt => {
        if (!debt.payments) debt.payments = [];
        if (!debt.remainingAmount) {
            debt.remainingAmount = debt.totalAmount - (debt.paidAmount || 0);
        }
    });
    
    refreshUI();
  }

  function refreshUI(){
    welcomeText.textContent = currentUser ? ('Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ' + currentUser) : 'Ù…Ø±Ø­Ø¨Ø§Ù‹';
    updateDebtorSelect();
    renderDebts();
    renderQats();
    updateSummary();
    updateDashboard();
    updateSettingsStats();
  }

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†
  function addDebt(){
    const name = document.getElementById('debtName').value.trim();
    const amount = parseFloat(document.getElementById('debtAmount').value);
    const date = document.getElementById('debtDate').value || new Date().toISOString().slice(0,10);
    const timeOfDay = document.getElementById('debtTime').value || 'ØµØ¨Ø§Ø­Ø§Ù‹';
    
    if(!name || !amount || amount <= 0){ 
      showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­ Ù„Ù„Ø¯ÙŠÙ†', 'error');
      return; 
    }

    const existingDebtIndex = debts.findIndex(debt => 
      debt.name === name && debt.date === date
    );

    if (existingDebtIndex !== -1) {
        const existingDebt = debts[existingDebtIndex];
        existingDebt.totalAmount += amount;
        existingDebt.remainingAmount += amount;
        showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¯ÙŠÙ† ${name} Ø¨Ù…Ø¨Ù„Øº ${amount} Ø±ÙŠØ§Ù„`);
    } else {
        debts.unshift({
            id: uid('d'),
            name, 
            totalAmount: amount,
            paidAmount: 0,
            remainingAmount: amount,
            date, 
            timeOfDay,
            payments: []
        });
        showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${name} Ø¨Ù…Ø¨Ù„Øº ${amount} Ø±ÙŠØ§Ù„`);
    }
    
    saveToLocalStorage();
    syncToFirebase();
    renderDebts();
    updateSummary();
    updateDashboard();
    updateDebtorSelect();
    
    document.getElementById('debtName').value = '';
    document.getElementById('debtAmount').value = '';
    document.getElementById('debtDate').value = '';
    document.getElementById('debtTime').value = 'ØµØ¨Ø§Ø­Ø§Ù‹';
  }

  function updateDebtorSelect() {
    const debtorSelect = document.getElementById('debtorSelect');
    if (!debtorSelect) return;
    
    debtorSelect.innerHTML = '<option value="">ğŸ‘¤ Ø§Ø®ØªØ± Ø§Ù„Ù…ØªØ¯ÙŠÙ†</option>';
    const debtors = {};
    
    debts.forEach(debt => {
        if (debt.remainingAmount > 0) {
            if (!debtors[debt.name]) {
                debtors[debt.name] = {
                    totalRemaining: 0,
                    debts: []
                };
            }
            debtors[debt.name].totalRemaining += debt.remainingAmount;
            debtors[debt.name].debts.push(debt);
        }
    });

    Object.keys(debtors).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `${name} (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${debtors[name].totalRemaining} Ø±ÙŠØ§Ù„)`;
        debtorSelect.appendChild(option);
    });
  }

  function addPayment() {
    const debtorSelect = document.getElementById('debtorSelect');
    const paymentAmount = document.getElementById('paymentAmount');
    const paymentDate = document.getElementById('paymentDate');
    
    if (!debtorSelect || !paymentAmount) return;
    
    const debtorName = debtorSelect.value;
    const amount = parseFloat(paymentAmount.value);
    const date = paymentDate.value || new Date().toISOString().slice(0,10);
    
    if(!debtorName || !amount || amount <= 0){ 
      showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØªØ¯ÙŠÙ† ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØªØ³Ø¯ÙŠØ¯ ØµØ­ÙŠØ­', 'error');
      return; 
    }

    const debtorDebts = debts.filter(debt => 
      debt.name === debtorName && debt.remainingAmount > 0
    );

    if (debtorDebts.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯ÙŠÙ†', 'error');
        return;
    }

    let remainingPayment = amount;
    let totalPaid = 0;
    
    debtorDebts.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    for (let debt of debtorDebts) {
        if (remainingPayment <= 0) break;
        
        const paymentAmount = Math.min(remainingPayment, debt.remainingAmount);
        debt.paidAmount += paymentAmount;
        debt.remainingAmount -= paymentAmount;
        remainingPayment -= paymentAmount;
        totalPaid += paymentAmount;
        
        debt.payments.unshift({
            id: uid('p'),
            amount: paymentAmount,
            date
        });
    }

    if (remainingPayment > 0) {
        showToast(`ØªÙ… ØªØ³Ø¯ÙŠØ¯ ${totalPaid} Ø±ÙŠØ§Ù„ØŒ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø§Ø¦Ø¯: ${remainingPayment} Ø±ÙŠØ§Ù„ Ø³ÙŠÙØ¹Ø§Ø¯`, 'warning');
    } else {
        showToast(`ØªÙ… ØªØ³Ø¯ÙŠØ¯ ${totalPaid} Ø±ÙŠØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ ${debtorName}`);
    }

    saveToLocalStorage();
    syncToFirebase();
    renderDebts();
    updateSummary();
    updateDashboard();
    updateDebtorSelect();
    
    paymentAmount.value = '';
    paymentDate.value = '';
  }

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµÙŠÙŠØ±
  function renderDebts() {
    const debtsListEl = document.getElementById('debtsList');
    if (!debtsListEl) return;
    
    debtsListEl.innerHTML = '';
    
    if(!debts.length){ 
      debtsListEl.innerHTML='<p style="text-align:center;padding:20px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>'; 
      return; 
    }

    debts.forEach(debt => {
        const debtCard = document.createElement('div');
        debtCard.className = 'list-item debt-item fade-in';
        
        const debtColor = getDebtColor(debt.remainingAmount, debt.totalAmount);
        
        debtCard.innerHTML = `
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">${debt.name}</h4>
              <span class="${debtColor}">${debt.remainingAmount} / ${debt.totalAmount} Ø±ÙŠØ§Ù„</span>
            </div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
              ${debt.date} - ${debt.timeOfDay}
            </div>
            ${debt.payments.length > 0 ? `
              <div class="payment-section">
                <strong>Ø§Ù„ØªØ³Ø¯ÙŠØ¯Ø§Øª:</strong>
                ${debt.payments.map(payment => `
                  <div style="font-size:12px; margin-top:4px;">
                    +${payment.amount} Ø±ÙŠØ§Ù„ ÙÙŠ ${payment.date}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
        
        debtsListEl.appendChild(debtCard);
    });
  }

  function getDebtColor(remaining, total) {
    if (remaining === 0) return 'debt-paid';
    const percentage = (remaining / total) * 100;
    if (percentage >= 70) return 'debt-high';
    if (percentage >= 30) return 'debt-medium';
    return 'debt-low';
  }

  function updateSummary() {
    const total = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
    const paid = debts.reduce((sum, debt) => sum + debt.paidAmount, 0);
    const remaining = total - paid;

    const totalDebtsEl = document.getElementById('totalDebts');
    const totalPaidEl = document.getElementById('totalPaid');
    const totalRemainingEl = document.getElementById('totalRemaining');
    
    if (totalDebtsEl) totalDebtsEl.textContent = total.toLocaleString() + ' Ø±ÙŠØ§Ù„';
    if (totalPaidEl) totalPaidEl.textContent = paid.toLocaleString() + ' Ø±ÙŠØ§Ù„';
    if (totalRemainingEl) totalRemainingEl.textContent = remaining.toLocaleString() + ' Ø±ÙŠØ§Ù„';
  }

  function renderDebtsSummary() {
    const debtsSummaryEl = document.getElementById('debtsSummary');
    if (!debtsSummaryEl) return;
    
    debtsSummaryEl.innerHTML = '';
    
    if(!debts.length){ 
      debtsSummaryEl.innerHTML='<p style="text-align:center;padding:20px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>'; 
      return; 
    }

    const debtors = {};
    
    debts.forEach(debt => {
        if (!debtors[debt.name]) {
            debtors[debt.name] = {
                total: 0,
                paid: 0,
                remaining: 0,
                debts: []
            };
        }
        debtors[debt.name].total += debt.totalAmount;
        debtors[debt.name].paid += debt.paidAmount;
        debtors[debt.name].remaining += debt.remainingAmount;
        debtors[debt.name].debts.push(debt);
    });

    Object.keys(debtors).forEach(name => {
        const debtorCard = document.createElement('div');
        debtorCard.className = 'list-item debt-item fade-in';
        
        const debtColor = getDebtColor(debtors[name].remaining, debtors[name].total);
        
        debtorCard.innerHTML = `
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">${name}</h4>
              <span class="${debtColor}">${debtors[name].remaining} / ${debtors[name].total} Ø±ÙŠØ§Ù„</span>
            </div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
              Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯: ${debtors[name].paid} Ø±ÙŠØ§Ù„
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${(debtors[name].paid / debtors[name].total) * 100}%"></div>
            </div>
          </div>
        `;
        
        debtsSummaryEl.appendChild(debtorCard);
    });
  }

  function updateDashboard() {
    const total = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
    const paid = debts.reduce((sum, debt) => sum + debt.paidAmount, 0);
    const remaining = total - paid;
    const totalQat = qats.reduce((sum, qat) => sum + parseInt(qat.count || 0), 0);
    
    const dashboardTotalDebts = document.getElementById('dashboardTotalDebts');
    const dashboardTotalPaid = document.getElementById('dashboardTotalPaid');
    const dashboardTotalRemaining = document.getElementById('dashboardTotalRemaining');
    const dashboardTotalQat = document.getElementById('dashboardTotalQat');
    
    if (dashboardTotalDebts) dashboardTotalDebts.textContent = total.toLocaleString();
    if (dashboardTotalPaid) dashboardTotalPaid.textContent = paid.toLocaleString();
    if (dashboardTotalRemaining) dashboardTotalRemaining.textContent = remaining.toLocaleString();
    if (dashboardTotalQat) dashboardTotalQat.textContent = totalQat.toLocaleString();

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    const recentDebts = debts.slice(0, 5);
    const recentDebtsElement = document.getElementById('recentDebts');
    if (recentDebtsElement) {
        recentDebtsElement.innerHTML = recentDebts.map(debt => `
          <div class="list-item debt-item">
            <div>
              <strong>${debt.name}</strong>
              <div style="font-size: 12px; color: var(--muted);">
                ${debt.date} - ${debt.timeOfDay}
              </div>
            </div>
            <span class="${getDebtColor(debt.remainingAmount, debt.totalAmount)}">
              ${debt.totalAmount} Ø±ÙŠØ§Ù„
            </span>
          </div>
        `).join('');
    }

    // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø§Ù„ØªØ³Ø¯ÙŠØ¯Ø§Øª
    const recentPaymentsElement = document.getElementById('recentPayments');
    if (recentPaymentsElement) {
        const allPayments = [];
        debts.forEach(debt => {
            debt.payments.forEach(payment => {
                allPayments.push({
                    name: debt.name,
                    amount: payment.amount,
                    date: payment.date
                });
            });
        });
        
        const recentPayments = allPayments.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
        
        recentPaymentsElement.innerHTML = recentPayments.map(payment => `
          <div class="list-item debt-item">
            <div>
              <strong>${payment.name}</strong>
              <div style="font-size: 12px; color: var(--muted);">
                ${payment.date}
              </div>
            </div>
            <span style="color: var(--success);">
              +${payment.amount} Ø±ÙŠØ§Ù„
            </span>
          </div>
        `).join('');
    }
  }

  function updateSettingsStats() {
    const totalDebts = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
    const totalRecords = debts.length + qats.length;
    const activeDebts = debts.filter(debt => debt.remainingAmount > 0).length;
    const qatRecords = qats.length;
    
    const backupInfo = backupData ? 
        `Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: ${new Date(backupData.timestamp).toLocaleString('ar-SA')}` : 
        'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø©';

    document.getElementById('statsTotalDebts').textContent = totalDebts.toLocaleString();
    document.getElementById('statsTotalRecords').textContent = totalRecords.toLocaleString();
    document.getElementById('statsActiveDebts').textContent = activeDebts.toLocaleString();
    document.getElementById('statsQatRecords').textContent = qatRecords.toLocaleString();
    
    const backupStatus = document.getElementById('backupStatus');
    if (backupStatus) {
        backupStatus.textContent = backupInfo;
    }
  }

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Øª
  function addQat(){
    const type = document.getElementById('qatType').value.trim();
    const count = document.getElementById('qatCountInput').value.trim();
    const date = document.getElementById('qatDate').value || new Date().toISOString().slice(0,10);
    
    if(!type || !count){ 
      showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ù‚Ø§Øª', 'error');
      return; 
    }
    
    qats.unshift({
        id: uid('q'), 
        type, 
        count, 
        date
    });
    
    saveToLocalStorage();
    syncToFirebase();
    renderQats();
    updateDashboard();
    updateSettingsStats();
    showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${count} Ù…Ù† Ù†ÙˆØ¹ ${type}`);
    
    document.getElementById('qatType').value = '';
    document.getElementById('qatCountInput').value = '';
    document.getElementById('qatDate').value = '';
  }

  function renderQats(){
    const qatListEl = document.getElementById('qatList');
    if (!qatListEl) return;
    
    qatListEl.innerHTML='';
    
    if(!qats.length){ 
      qatListEl.innerHTML='<p style="text-align:center;padding:20px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>'; 
      return; 
    }
    
    qats.forEach(qat=>{
        const div=document.createElement('div');
        div.className='list-item qat-item fade-in';
        div.innerHTML = `
          <div>
            <strong>${qat.type}</strong>
            <div style="font-size:12px; color:var(--muted);">${qat.date}</div>
          </div>
          <span>${qat.count}</span>
        `;
        qatListEl.appendChild(div);
    });
  }

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
  const syncStatus = document.getElementById('syncStatus');
  const syncIcon = document.getElementById('syncIcon');
  const syncText = document.getElementById('syncText');

  function updateSyncStatus(status, text) {
    if (!syncStatus) return;
    
    syncStatus.classList.remove('hidden', 'online', 'offline', 'syncing');
    
    if (status === 'online') {
        syncStatus.classList.add('online');
        syncIcon.textContent = 'âœ“';
        syncText.textContent = text || 'Ù…Ø²Ø§Ù…Ù†Ø©';
    } else if (status === 'offline') {
        syncStatus.classList.add('offline');
        syncIcon.textContent = '!';
        syncText.textContent = text || 'ØºÙŠØ± Ù…ØªØµÙ„';
    } else if (status === 'syncing') {
        syncStatus.classList.add('syncing');
        syncIcon.textContent = 'â†»';
        syncText.textContent = text || 'Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';
    }
    
    syncStatus.classList.remove('hidden');
  }

  async function syncToFirebase() {
    if (!currentUser || !isOnline) return;
    
    syncInProgress = true;
    updateSyncStatus('syncing', 'Ø¬Ø§Ø±Ù Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    
    try {
        await database.ref(`users/${currentUser}`).set({
            debts: debts,
            qats: qats,
            password: userPassword,
            lastSync: new Date().toISOString()
        });
        
        updateSyncStatus('online', 'ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        setTimeout(() => {
            if (!syncInProgress) updateSyncStatus('online', 'Ù…Ø²Ø§Ù…Ù†Ø©');
        }, 3000);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
        updateSyncStatus('offline', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
    }
    
    syncInProgress = false;
  }

  async function loadFromFirebase() {
    if (!currentUser || !isOnline) return;
    
    updateSyncStatus('syncing', 'Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    
    try {
        const snapshot = await database.ref(`users/${currentUser}`).once('value');
        const data = snapshot.val();
        
        if (data) {
            debts = data.debts || [];
            qats = data.qats || [];
            userPassword = data.password || hashPassword('123456');
            
            debts.forEach(debt => {
                if (!debt.day) {
                    debt.day = getDayName(debt.date);
                }
            });
            
            saveToLocalStorage();
            
            updateSyncStatus('online', 'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            setTimeout(() => {
                if (!syncInProgress) updateSyncStatus('online', 'Ù…Ø²Ø§Ù…Ù†Ø©');
            }, 3000);
            
            return true;
        }
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        updateSyncStatus('offline', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
    }
    
    return false;
  }

  function getDayName(dateString) {
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    const date = new Date(dateString);
    return days[date.getDay()];
  }

  function checkConnection() {
    const onlineStatus = navigator.onLine;
    
    if (onlineStatus !== isOnline) {
        isOnline = onlineStatus;
        
        if (isOnline) {
            updateSyncStatus('online', 'Ù…ØªØµÙ„ - Ù…Ø²Ø§Ù…Ù†Ø©');
            setTimeout(() => enhancedSync(), 2000);
        } else {
            updateSyncStatus('offline', 'ØºÙŠØ± Ù…ØªØµÙ„');
        }
    }
  }

  async function enhancedSync() {
    if (!currentUser) return;
    
    const lastLocalUpdate = localStorage.getItem(`lastUpdate_${currentUser}`);
    const lastCloudUpdate = await getLastCloudUpdate();
    
    if (lastCloudUpdate > lastLocalUpdate) {
        await loadFromFirebase();
        showToast('ğŸ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    } else if (lastLocalUpdate > lastCloudUpdate) {
        await syncToFirebase();
        showToast('â˜ï¸ ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
    } else {
        showToast('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©');
    }
  }

  async function getLastCloudUpdate() {
    try {
        const snapshot = await database.ref(`users/${currentUser}/lastSync`).once('value');
        return snapshot.val() || '0';
    } catch (error) {
        return '0';
    }
  }

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel Ùˆ Word
  async function exportToExcel(data, filename) {
    if (data.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
        return;
    }
    
    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", {
            views: [{ showGridLines: true }],
            pageSetup: { 
                paperSize: 9,
                orientation: 'landscape',
                margins: { left: 0.7, right: 0.7, top: 0.75, bottom: 0.75, header: 0.3, footer: 0.3 }
            }
        });

        // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        const titleRow = worksheet.addRow(['ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª']);
        titleRow.font = { name: 'Arial', size: 16, bold: true, color: { argb: 'FF2E86AB' } };
        titleRow.alignment = { vertical: 'middle', horizontal: 'center' };
        worksheet.mergeCells(`A1:${String.fromCharCode(64 + Object.keys(data[0]).length)}1`);
        titleRow.height = 30;

        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ±
        const infoRow = worksheet.addRow([
            `ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±: ${new Date().toLocaleDateString('ar-SA')}`,
            `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser}`,
            `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${data.length}`
        ]);
        infoRow.font = { name: 'Arial', size: 10, color: { argb: 'FF666666' } };
        infoRow.alignment = { vertical: 'middle', horizontal: 'center' };
        worksheet.mergeCells(`A2:${String.fromCharCode(64 + Object.keys(data[0]).length)}2`);

        // Ø³Ø·Ø± ÙØ§Ø±Øº
        worksheet.addRow([]);

        // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
        const headers = Object.keys(data[0]);
        const headerRow = worksheet.addRow(headers);
        
        headerRow.eachCell((cell, colNumber) => {
            cell.font = {
                name: 'Arial',
                size: 12,
                bold: true,
                color: { argb: 'FFFFFFFF' }
            };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FF2E86AB' }
            };
            cell.alignment = {
                vertical: 'middle',
                horizontal: 'center',
                wrapText: true
            };
            cell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: 'thin', color: { argb: 'FF000000' } }
            };
        });
        headerRow.height = 25;

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        data.forEach((row, rowIndex) => {
            const dataRow = worksheet.addRow(Object.values(row));
            
            dataRow.eachCell((cell, colNumber) => {
                cell.font = {
                    name: 'Arial',
                    size: 10
                };
                cell.alignment = {
                    vertical: 'middle',
                    horizontal: 'right',
                    wrapText: true
                };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    left: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    bottom: { style: 'thin', color: { argb: 'FFCCCCCC' } },
                    right: { style: 'thin', color: { argb: 'FFCCCCCC' } }
                };

                if (rowIndex % 2 === 0) {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                }
            });
            dataRow.height = 20;
        });

        // Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        worksheet.columns.forEach(column => {
            let maxLength = 0;
            column.eachCell({ includeEmpty: true }, cell => {
                try {
                    const cellValue = cell.value ? cell.value.toString() : '';
                    const columnLength = cellValue.length;
                    if (columnLength > maxLength) {
                        maxLength = columnLength;
                    }
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø®Ù„ÙŠØ©:', error);
                }
            });
            column.width = Math.min(Math.max(maxLength + 3, 12), 35);
        });

        // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø£ÙˆÙ„Ù‰
        worksheet.views = [
            { state: 'frozen', xSplit: 0, ySplit: 4 }
        ];

        // ØªÙˆÙ‚ÙŠØ¹
        const signatureRow = worksheet.addRow(['ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª']);
        signatureRow.font = { name: 'Arial', size: 9, italic: true, color: { argb: 'FF999999' } };
        signatureRow.alignment = { vertical: 'middle', horizontal: 'center' };
        worksheet.mergeCells(`A${worksheet.rowCount}:${String.fromCharCode(64 + Object.keys(data[0]).length)}${worksheet.rowCount}`);

        // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `${filename}.xlsx`);
        showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ${filename}.xlsx`);
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel:', error);
        showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel', 'error');
    }
  }

  async function exportToWord(data, title, filename) {
    if (data.length === 0) {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
        return;
    }
    
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ HTML Ù…Ø¨Ø³Ø· ÙˆÙ…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Word
        let htmlContent = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" 
      xmlns:w="urn:schemas-microsoft-com:office:word" 
      xmlns="http://www.w3.org//TR/REC-html40">
<head>
    <meta charset="UTF-8">
    <title>${title}</title>
    <style>
        body {
            font-family: 'Simplified Arabic', 'Times New Roman', serif;
            direction: rtl;
            text-align: right;
            margin: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #2E86AB;
            padding-bottom: 15px;
        }
        .header h1 {
            color: #2E86AB;
            font-size: 24px;
            margin-bottom: 10px;
        }
        .info-section {
            background: #f8f9fa;
            padding: 15px;
            margin: 20px 0;
            border-right: 4px solid #2E86AB;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        table, th, td {
            border: 1px solid #000000;
        }
        th {
            background-color: #2E86AB;
            color: white;
            padding: 10px;
            text-align: right;
            font-weight: bold;
        }
        td {
            padding: 8px 10px;
            text-align: right;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            font-size: 11px;
            color: #666;
        }
        .total-row {
            background-color: #e8f5e8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>${title}</h1>
        <div>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
    </div>

    <div class="info-section">
        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ¯ÙŠØ±:</strong> ${new Date().toLocaleDateString('ar-SA')}</div>
        <div><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${currentUser}</div>
        <div><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:</strong> ${data.length}</div>
    </div>

    <table>
        <thead>
            <tr>
`;

        // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
        Object.keys(data[0]).forEach(header => {
            htmlContent += `               <th>${header}</th>\n`;
        });

        htmlContent += `            </tr>
        </thead>
        <tbody>
`;

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        data.forEach((row, index) => {
            const isTotalRow = index === data.length - 1 && row['Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†'] === 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ';
            const rowClass = isTotalRow ? 'total-row' : '';
            
            htmlContent += `            <tr class="${rowClass}">\n`;
            Object.values(row).forEach(cell => {
                htmlContent += `               <td>${cell}</td>\n`;
            });
            htmlContent += `            </tr>\n`;
        });

        htmlContent += `        </tbody>
    </table>

    <div class="footer">
        <div>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ù‚Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</div>
        <div>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© ${new Date().getFullYear()}</div>
        <div style="margin-top: 20px;">
            <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: _________________________</div>
            <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: _________________________</div>
        </div>
    </div>
</body>
</html>`;

        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Word
        const blob = new Blob([htmlContent], { 
            type: 'application/msword'
        });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${filename}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ${filename}.doc`);

    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Word:', error);
        showToast('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Word', 'error');
    }
  }

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
  function filterDebts(searchTerm) {
    const debtsListEl = document.getElementById('debtsList');
    if (!debtsListEl) return;
    
    debtsListEl.innerHTML = '';
    
    const filteredDebts = debts.filter(debt => 
        debt.name.toLowerCase().includes(searchTerm) ||
        debt.date.includes(searchTerm) ||
        debt.timeOfDay.includes(searchTerm) ||
        debt.totalAmount.toString().includes(searchTerm)
    );
    
    if(filteredDebts.length === 0){ 
        debtsListEl.innerHTML='<p style="text-align:center;padding:20px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</p>'; 
        return; 
    }

    filteredDebts.forEach(debt => {
        const debtCard = document.createElement('div');
        debtCard.className = 'list-item debt-item fade-in';
        
        const debtColor = getDebtColor(debt.remainingAmount, debt.totalAmount);
        
        debtCard.innerHTML = `
          <div style="flex:1;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <h4 style="margin:0;">${debt.name}</h4>
              <span class="${debtColor}">${debt.remainingAmount} / ${debt.totalAmount} Ø±ÙŠØ§Ù„</span>
            </div>
            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
              ${debt.date} - ${debt.timeOfDay}
            </div>
            ${debt.payments.length > 0 ? `
              <div class="payment-section">
                <strong>Ø§Ù„ØªØ³Ø¯ÙŠØ¯Ø§Øª:</strong>
                ${debt.payments.map(payment => `
                  <div style="font-size:12px; margin-top:4px;">
                    +${payment.amount} Ø±ÙŠØ§Ù„ ÙÙŠ ${payment.date}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
        
        debtsListEl.appendChild(debtCard);
    });
  }

  function filterQats(searchTerm) {
    const qatListEl = document.getElementById('qatList');
    if (!qatListEl) return;
    
    qatListEl.innerHTML = '';
    
    const filteredQats = qats.filter(qat => 
        qat.type.toLowerCase().includes(searchTerm) ||
        qat.date.includes(searchTerm) ||
        qat.count.toString().includes(searchTerm)
    );
    
    if(filteredQats.length === 0){ 
        qatListEl.innerHTML='<p style="text-align:center;padding:20px;color:var(--muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</p>'; 
        return; 
    }
    
    filteredQats.forEach(qat => {
        const div = document.createElement('div');
        div.className = 'list-item qat-item fade-in';
        div.innerHTML = `
          <div>
            <strong>${qat.type}</strong>
            <div style="font-size:12px; color:var(--muted);">${qat.date}</div>
          </div>
          <span>${qat.count}</span>
        `;
        qatListEl.appendChild(div);
    });
  }

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…ØªØ¯ÙŠÙ†
  function showDebtDetails(searchTerm) {
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØªØ¯ÙŠÙ†ÙŠÙ† Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†
    const matchingDebts = debts.filter(debt => 
        debt.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        debt.date.includes(searchTerm)
    );

    if (matchingDebts.length === 0) {
        showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«', 'error');
        return;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†
    const debtors = {};
    matchingDebts.forEach(debt => {
        if (!debtors[debt.name]) {
            debtors[debt.name] = {
                total: 0,
                paid: 0,
                remaining: 0,
                debts: []
            };
        }
        debtors[debt.name].total += debt.totalAmount;
        debtors[debt.name].paid += debt.paidAmount;
        debtors[debt.name].remaining += debt.remainingAmount;
        debtors[debt.name].debts.push(debt);
    });

    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
    const debtHistoryCard = document.getElementById('debtHistoryCard');
    const debtHistoryList = document.getElementById('debtHistoryList');
    
    if (debtHistoryCard && debtHistoryList) {
        debtHistoryCard.classList.remove('hidden');
        
        debtHistoryList.innerHTML = '';
        
        Object.keys(debtors).forEach(name => {
            const debtor = debtors[name];
            const debtColor = getDebtColor(debtor.remaining, debtor.total);
            
            const debtorSection = document.createElement('div');
            debtorSection.className = 'list-item debt-item fade-in';
            debtorSection.style.marginBottom = '20px';
            
            debtorSection.innerHTML = `
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:var(--primary);">${name}</h4>
                        <span class="${debtColor}" style="font-size:18px;">
                            ${debtor.remaining} / ${debtor.total} Ø±ÙŠØ§Ù„
                        </span>
                    </div>
                    
                    <div class="progress-bar" style="margin:10px 0;">
                        <div class="progress-fill" style="width: ${(debtor.paid / debtor.total) * 100}%"></div>
                    </div>
                    
                    <div style="font-size:12px; color:var(--muted); margin-bottom:10px;">
                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¯Ø¯: ${debtor.paid} Ø±ÙŠØ§Ù„ | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${debtor.remaining} Ø±ÙŠØ§Ù„
                    </div>
                    
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px;">
                        <h5 style="margin:0 0 10px 0; color:var(--success);">Ø§Ù„ØªØ³Ø¯ÙŠØ¯Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©:</h5>
                        ${debtor.debts.map(debt => `
                            <div style="margin-bottom:8px; padding:8px; background:rgba(255,255,255,0.02); border-radius:6px;">
                                <div style="display:flex; justify-content:space-between;">
                                    <strong>${debt.date} - ${debt.timeOfDay}</strong>
                                    <span>${debt.totalAmount} Ø±ÙŠØ§Ù„</span>
                                </div>
                                ${debt.payments.length > 0 ? `
                                    <div style="margin-top:5px; font-size:11px;">
                                        ${debt.payments.map(payment => `
                                            <div style="color:var(--success);">
                                                âœ“ ØªØ³Ø¯ÙŠØ¯ ${payment.amount} Ø±ÙŠØ§Ù„ ÙÙŠ ${payment.date}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="color:var(--muted); font-size:11px;">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯</div>'}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            debtHistoryList.appendChild(debtorSection);
        });

        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
        debtHistoryCard.scrollIntoView({ behavior: 'smooth' });
        showToast(`ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ù€ ${Object.keys(debtors).length} Ù…ØªØ¯ÙŠÙ†`);
    }
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
  function setupEventListeners() {
    // Ø£Ø­Ø¯Ø§Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const loginPage = document.getElementById('loginPage');
    const appPage = document.getElementById('appPage');
    const loginName = document.getElementById('loginName');
    const loginPassword = document.getElementById('loginPassword');
    const loginMessage = document.getElementById('loginMessage');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const logoutBtn = document.getElementById('logoutBtn');
    const welcomeText = document.getElementById('welcomeText');

    btnLogin.addEventListener('click', function(){
        const name = loginName.value.trim();
        const password = loginPassword.value.trim();
        
        const result = loginUser(name, password);
        
        if (result.success) {
            showApp();
            showToast(result.message);
        } else {
            loginMessage.textContent = result.message;
            loginMessage.style.color = 'var(--danger)';
        }
    });

    btnRegister.addEventListener('click', function(){
        const name = loginName.value.trim();
        const password = loginPassword.value.trim();
        
        const result = createAccount(name, password);
        
        if (result.success) {
            showApp();
            showToast(result.message);
        } else {
            loginMessage.textContent = result.message;
            loginMessage.style.color = 'var(--danger)';
        }
    });

    logoutBtn.addEventListener('click', ()=>{
        localStorage.removeItem(KEY_USER);
        currentUser = null;
        userPassword = null;
        showLogin();
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ†Ù‚Ù„
    const navDebts = document.getElementById('navDebts');
    const navQat = document.getElementById('navQat');
    const navSummary = document.getElementById('navSummary');
    const navDashboard = document.getElementById('navDashboard');
    const navSettings = document.getElementById('navSettings');

    navDebts.addEventListener('click', () => showPage('debtsPage'));
    navQat.addEventListener('click', () => showPage('qatPage'));
    navSummary.addEventListener('click', () => showPage('summaryPage'));
    navDashboard.addEventListener('click', () => showPage('dashboardPage'));
    navSettings.addEventListener('click', () => showPage('settingsPage'));

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¯ÙŠÙˆÙ†
    const saveDebtBtn = document.getElementById('saveDebt');
    const savePaymentBtn = document.getElementById('savePayment');
    const saveQatBtn = document.getElementById('saveQat');
    const clearDebtBtn = document.getElementById('clearDebt');
    const clearQatBtn = document.getElementById('clearQat');
    
    if (saveDebtBtn) saveDebtBtn.addEventListener('click', addDebt);
    if (savePaymentBtn) savePaymentBtn.addEventListener('click', addPayment);
    if (saveQatBtn) saveQatBtn.addEventListener('click', addQat);
    
    if (clearDebtBtn) clearDebtBtn.addEventListener('click', () => {
        document.getElementById('debtName').value = '';
        document.getElementById('debtAmount').value = '';
        document.getElementById('debtDate').value = '';
        document.getElementById('debtTime').value = 'ØµØ¨Ø§Ø­Ø§Ù‹';
        showToast('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„');
    });
    
    if (clearQatBtn) clearQatBtn.addEventListener('click', () => {
        document.getElementById('qatType').value = '';
        document.getElementById('qatCountInput').value = '';
        document.getElementById('qatDate').value = '';
        showToast('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„');
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ§Ø±ÙŠØ®
    const setTodayDebt = document.getElementById('setTodayDebt');
    const setYesterdayDebt = document.getElementById('setYesterdayDebt');
    const setTodayQat = document.getElementById('setTodayQat');
    const setYesterdayQat = document.getElementById('setYesterdayQat');
    
    if (setTodayDebt) setTodayDebt.addEventListener('click', () => setDateToField('debtDate', 0));
    if (setYesterdayDebt) setYesterdayDebt.addEventListener('click', () => setDateToField('debtDate', -1));
    if (setTodayQat) setTodayQat.addEventListener('click', () => setDateToField('qatDate', 0));
    if (setYesterdayQat) setYesterdayQat.addEventListener('click', () => setDateToField('qatDate', -1));

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØµØ¯ÙŠØ±
    const exportExcel = document.getElementById('exportExcel');
    const exportWord = document.getElementById('exportWord');
    const exportSummaryExcel = document.getElementById('exportSummaryExcel');
    const exportSummaryWord = document.getElementById('exportSummaryWord');
    
    if (exportExcel) exportExcel.addEventListener('click', () => exportDebtsToExcel());
    if (exportWord) exportWord.addEventListener('click', () => exportDebtsToWord());
    if (exportSummaryExcel) exportSummaryExcel.addEventListener('click', () => exportSummaryToExcel());
    if (exportSummaryWord) exportSummaryWord.addEventListener('click', () => exportSummaryToWord());

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    const changePassword = document.getElementById('changePassword');
    const deleteData = document.getElementById('deleteData');
    const exportAllData = document.getElementById('exportAllData');
    const importData = document.getElementById('importData');
    
    if (changePassword) changePassword.addEventListener('click', () => showChangePasswordModal());
    if (deleteData) deleteData.addEventListener('click', () => deleteAllData());
    if (exportAllData) exportAllData.addEventListener('click', () => exportDataToFile());
    if (importData) importData.addEventListener('click', () => importDataFromFile());

    // Ø£Ø­Ø¯Ø§Ø« Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const changePasswordModal = document.getElementById('changePasswordModal');
    const saveNewPassword = document.getElementById('saveNewPassword');
    const cancelChangePassword = document.getElementById('cancelChangePassword');
    
    if (saveNewPassword) saveNewPassword.addEventListener('click', changePasswordHandler);
    if (cancelChangePassword) cancelChangePassword.addEventListener('click', () => {
        changePasswordModal.classList.add('hidden');
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Enter
    const searchDebts = document.getElementById('searchDebts');
    const searchQat = document.getElementById('searchQat');
    const quickSearchBtn = document.getElementById('quickSearchBtn');
    
    if (searchDebts) {
        searchDebts.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterDebts(searchTerm);
        });
        
        // Ø­Ø¯Ø« Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¬Ù„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
        searchDebts.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim();
                if (searchTerm) {
                    showDebtDetails(searchTerm);
                }
            }
        });
    }

    if (searchQat) {
        searchQat.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            filterQats(searchTerm);
        });
    }

    // Ø­Ø¯Ø« Ø²Ø± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
    if (quickSearchBtn) {
        quickSearchBtn.addEventListener('click', function() {
            const searchTerm = document.getElementById('searchDebts').value.trim();
            if (searchTerm) {
                showDebtDetails(searchTerm);
            } else {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ù„Ù„Ø¨Ø­Ø«', 'warning');
            }
        });
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù…
    setupDaysDropdowns();
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù…
  function setupDaysDropdowns() {
    const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„Ø¯ÙŠÙ†
    const daysDropdownDebt = document.getElementById('daysDropdownDebt');
    if (daysDropdownDebt) {
        daysDropdownDebt.innerHTML = days.map((day, index) => `
            <button type="button" data-day="${index}">${day}</button>
        `).join('');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„ØªØ³Ø¯ÙŠØ¯
    const daysDropdownPayment = document.getElementById('daysDropdownPayment');
    if (daysDropdownPayment) {
        daysDropdownPayment.innerHTML = days.map((day, index) => `
            <button type="button" data-day="${index}">${day}</button>
        `).join('');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù… Ù„Ù„Ù‚Ø§Øª
    const daysDropdownQat = document.getElementById('daysDropdownQat');
    if (daysDropdownQat) {
        daysDropdownQat.innerHTML = days.map((day, index) => `
            <button type="button" data-day="${index}">${day}</button>
        `).join('');
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù…
    document.querySelectorAll('.days-dropdown button').forEach(button => {
        button.addEventListener('click', (e) => {
            const dayOfWeek = parseInt(e.target.getAttribute('data-day'));
            const selector = e.target.closest('.day-selector');
            const dateField = selector.parentElement.querySelector('input[type="date"]');
            
            setDateByDayOfWeek(dateField, dayOfWeek);
            selector.classList.remove('active');
        });
    });

    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    document.querySelectorAll('.day-selector > button').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation();
            const selector = e.target.closest('.day-selector');
            document.querySelectorAll('.day-selector').forEach(s => {
                if (s !== selector) s.classList.remove('active');
            });
            selector.classList.toggle('active');
        });
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', () => {
        document.querySelectorAll('.day-selector').forEach(selector => {
            selector.classList.remove('active');
        });
    });
  }

  function setDateByDayOfWeek(dateField, dayOfWeek) {
    const date = new Date();
    const currentDay = date.getDay();
    const diff = dayOfWeek - currentDay;
    date.setDate(date.getDate() + diff);
    dateField.value = date.toISOString().slice(0,10);
  }

  function setDateToField(fieldId, daysOffset = 0) {
    const date = new Date();
    date.setDate(date.getDate() + daysOffset);
    const field = document.getElementById(fieldId);
    if (field) {
        field.value = date.toISOString().slice(0,10);
    }
  }

  // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  function showChangePasswordModal() {
    const modal = document.getElementById('changePasswordModal');
    modal.classList.remove('hidden');
    
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
  }

  function changePasswordHandler() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    
    if (!current || !newPass || !confirm) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }
    
    if (!verifyPassword(current, userPassword)) {
        showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
        return;
    }
    
    if (newPass !== confirm) {
        showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', 'error');
        return;
    }
    
    if (newPass.length < 4) {
        showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
    }
    
    userPassword = hashPassword(newPass);
    saveToLocalStorage();
    syncToFirebase();
    document.getElementById('changePasswordModal').classList.add('hidden');
    showToast('ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
  }

  // ØªØ­Ø³ÙŠÙ† Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
  function enhanceDashboardButtons() {
    const quickActions = document.querySelectorAll('.quick-action-btn');
    
    quickActions.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px) scale(1.05)';
        });
        
        btn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
        
        btn.addEventListener('mousedown', function() {
            this.style.transform = 'translateY(-2px) scale(0.98)';
        });
        
        btn.addEventListener('mouseup', function() {
            this.style.transform = 'translateY(-5px) scale(1.05)';
        });
    });
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØµØ§Ù„ Firebase
  function setupConnectionMonitoring() {
    const connectionRef = database.ref('.info/connected');
    
    connectionRef.on('value', (snapshot) => {
        isOnline = snapshot.val() === true;
        
        if (isOnline) {
            showToast('ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
            setTimeout(() => enhancedSync(), 2000);
        } else {
            showToast('ğŸ“± ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', 'warning');
        }
    });
  }

  // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  function init() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª
    updateDateTime();
    setInterval(updateDateTime, 60000);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
    window.addEventListener('online', checkConnection);
    window.addEventListener('offline', checkConnection);
    setupConnectionMonitoring();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
    setupUserSystem();
    setupEventListeners();
    setupDashboardActions();
    enhanceDashboardButtons();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const storedUser = localStorage.getItem(KEY_USER);
    if(storedUser){
        currentUser = storedUser;
        loadFromLocalStorage();
        showApp();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Firebase
        setTimeout(() => enhancedSync(), 3000);
    }
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    const today = new Date().toISOString().slice(0,10);
    const debtDate = document.getElementById('debtDate');
    const qatDate = document.getElementById('qatDate');
    const paymentDate = document.getElementById('paymentDate');
    if (debtDate) debtDate.value = today;
    if (qatDate) qatDate.value = today;
    if (paymentDate) paymentDate.value = today;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
    if (currentUser) {
        const storedBackup = localStorage.getItem(`backup_${currentUser}`);
        if (storedBackup) {
            backupData = JSON.parse(storedBackup);
        }
    }
  }

  // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„ØªØµØ¯ÙŠØ±
  window.exportDebtsToExcel = async function() {
    closeExportModal();
    const totalAmount = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
    const paidAmount = debts.reduce((sum, debt) => sum + debt.paidAmount, 0);
    const remainingAmount = totalAmount - paidAmount;

    const data = debts.map(debt => ({
        'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†': debt.name,
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': debt.date,
        'Ø§Ù„ÙˆÙ‚Øª': debt.timeOfDay,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': `${debt.totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯': `${debt.paidAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': `${debt.remainingAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯': `${((debt.paidAmount / debt.totalAmount) * 100).toFixed(1)}%`,
        'Ø§Ù„Ø­Ø§Ù„Ø©': debt.remainingAmount === 0 ? 'âœ… Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 
                  debt.paidAmount === 0 ? 'âŒ Ù„Ù… ÙŠØ³Ø¯Ø¯' : 'ğŸŸ¡ Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹'
    }));

    data.push({
        'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': '-',
        'Ø§Ù„ÙˆÙ‚Øª': '-',
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': `${totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³Ø¯Ø¯': `${paidAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': `${remainingAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯': `${((paidAmount / totalAmount) * 100).toFixed(1)}%`,
        'Ø§Ù„Ø­Ø§Ù„Ø©': remainingAmount === 0 ? 'âœ… ØªÙ… Ø³Ø¯Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†' : 'ğŸŸ¡ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…ØªØ¨Ù‚ÙŠØ©'
    });

    await exportToExcel(data, `ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø¯ÙŠÙˆÙ†-${new Date().toISOString().slice(0,10)}`);
  };

  window.exportDebtsToWord = async function() {
    closeExportModal();
    const totalAmount = debts.reduce((sum, debt) => sum + debt.totalAmount, 0);
    const paidAmount = debts.reduce((sum, debt) => sum + debt.paidAmount, 0);
    const remainingAmount = totalAmount - paidAmount;

    const data = debts.map(debt => ({
        'Ø§Ù„Ù…ØªØ¯ÙŠÙ†': debt.name,
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': debt.date,
        'Ø§Ù„ÙˆÙ‚Øª': debt.timeOfDay,
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': `${debt.totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø³Ø¯Ø¯': `${debt.paidAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': `${debt.remainingAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯': `${((debt.paidAmount / debt.totalAmount) * 100).toFixed(1)}%`,
        'Ø§Ù„Ø­Ø§Ù„Ø©': debt.remainingAmount === 0 ? 'Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 
                  debt.paidAmount === 0 ? 'Ù„Ù… ÙŠØ³Ø¯Ø¯' : 'Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹'
    }));

    data.push({
        'Ø§Ù„Ù…ØªØ¯ÙŠÙ†': 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        'Ø§Ù„ØªØ§Ø±ÙŠØ®': '-',
        'Ø§Ù„ÙˆÙ‚Øª': '-',
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': `${totalAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…Ø³Ø¯Ø¯': `${paidAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': `${remainingAmount.toLocaleString()} Ø±ÙŠØ§Ù„`,
        'Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯': `${((paidAmount / totalAmount) * 100).toFixed(1)}%`,
        'Ø§Ù„Ø­Ø§Ù„Ø©': remainingAmount === 0 ? 'ØªÙ… Ø³Ø¯Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙˆÙ†' : 'ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…ØªØ¨Ù‚ÙŠØ©'
    });

    await exportToWord(data, 'ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù„Ù„Ø¯ÙŠÙˆÙ†', `ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø¯ÙŠÙˆÙ†-${new Date().toISOString().slice(0,10)}`);
  };

  window.exportSummaryToExcel = async function() {
    closeExportModal();
    const debtors = {};
    
    debts.forEach(debt => {
        if (!debtors[debt.name]) {
            debtors[debt.name] = {
                total: 0,
                paid: 0,
                remaining: 0
            };
        }
        debtors[debt.name].total += debt.totalAmount;
        debtors[debt.name].paid += debt.paidAmount;
        debtors[debt.name].remaining += debt.remainingAmount;
    });

    const data = Object.keys(debtors).map(name => ({
        'Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯ÙŠÙ†': name,
        'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙ†': debtors[name].total + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ù…Ø³Ø¯Ø¯': debtors[name].paid + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': debtors[name].remaining + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ø­Ø§Ù„Ø©': debtors[name].remaining === 0 ? 'Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 
                  debtors[name].remaining === debtors[name].total ? 'Ù„Ù… ÙŠØ³Ø¯Ø¯' : 'Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹'
    }));
    
    await exportToExcel(data, `Ù…Ù„Ø®Øµ-Ø§Ù„Ø¯ÙŠÙˆÙ†-${new Date().toISOString().slice(0,10)}`);
  };

  window.exportSummaryToWord = async function() {
    closeExportModal();
    const debtors = {};
    
    debts.forEach(debt => {
        if (!debtors[debt.name]) {
            debtors[debt.name] = {
                total: 0,
                paid: 0,
                remaining: 0
            };
        }
        debtors[debt.name].total += debt.totalAmount;
        debtors[debt.name].paid += debt.paidAmount;
        debtors[debt.name].remaining += debt.remainingAmount;
    });

    const data = Object.keys(debtors).map(name => ({
        'Ø§Ù„Ù…ØªØ¯ÙŠÙ†': name,
        'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': debtors[name].total + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ù…Ø³Ø¯Ø¯': debtors[name].paid + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ': debtors[name].remaining + ' Ø±ÙŠØ§Ù„',
        'Ø§Ù„Ø­Ø§Ù„Ø©': debtors[name].remaining === 0 ? 'Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„' : 
                  debtors[name].remaining === debtors[name].total ? 'Ù„Ù… ÙŠØ³Ø¯Ø¯' : 'Ù…Ø³Ø¯Ø¯ Ø¬Ø²Ø¦ÙŠØ§Ù‹'
    }));
    
    await exportToWord(data, 'Ù…Ù„Ø®Øµ Ø§Ù„Ø¯ÙŠÙˆÙ†', `Ù…Ù„Ø®Øµ-Ø§Ù„Ø¯ÙŠÙˆÙ†-${new Date().toISOString().slice(0,10)}`);
  };

  window.closeExportModal = function() {
    const modal = document.getElementById('exportModal');
    if (modal) {
        modal.remove();
    }
  };

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  init();
  
})();
</script>
</body>
</html>
